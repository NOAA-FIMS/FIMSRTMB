<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Modify a FIMS module to make it callable from RTMB • FIMSRTMB</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Modify a FIMS module to make it callable from RTMB">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">FIMSRTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/NOAA-FIMS/FIMS/releases/tag/v0.1.0">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/noaa-fims/fims/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Modify a FIMS module to make it callable from RTMB</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/noaa-fims/fims/blob/main/vignettes/RTMB_add_module.Rmd" class="external-link"><code>vignettes/RTMB_add_module.Rmd</code></a></small>
      <div class="d-none name"><code>RTMB_add_module.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="step-1-navigate-to-the-rcpp-directory-and-rcpp-file-of-interest">Step 1 Navigate to the rcpp directory and rcpp file of interest<a class="anchor" aria-label="anchor" href="#step-1-navigate-to-the-rcpp-directory-and-rcpp-file-of-interest"></a>
</h2>
<p>The rcpp directory is located in
<code>inst/include/interface/rcpp/rcpp_objects</code>. Here, Rcpp
interface files are listed by category, e.g. <code>rcpp_growth</code>,
<code>rcpp_selectivity</code>, etc. This vignette will walk through
modifying the BevertonHolt recruitment function in
<code>rcpp_recruitment.hpp</code> to make it callable from RTMB.</p>
<p>At the top of the file, add the following if it isn’t already
included:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#include "../../RTMB.h"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-locate-the-bevertonholt-recruitment-evaluate_mean-function-in-rcpp_recruitment">Step 2 Locate the BevertonHolt recruitment
<code>evaluate_mean</code> function in
<code>rcpp_recruitment</code><a class="anchor" aria-label="anchor" href="#step-2-locate-the-bevertonholt-recruitment-evaluate_mean-function-in-rcpp_recruitment"></a>
</h2>
<p>Find the <code>BevertonHoltRecruitmentInterface</code>. Within this
class, locate the <code>evaluate_mean</code> function, this is where the
BevertonHolt C++ function is called. Note in other modules, this
function will just be called <code>evaluate()</code> This function needs
to be copied and the copy then modified to be callable from RTMB.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a> virtual double <span class="fu">evaluate_mean</span>(double spawners, double phi_0) {</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    fims_popdy<span class="sc">::</span>SRBevertonHolt<span class="sc">&lt;</span>double<span class="sc">&gt;</span> BevHolt;</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="fu">BevHolt.logit_steep.resize</span>(<span class="dv">1</span>);</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    BevHolt.logit_steep[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="cf">if</span> (this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m <span class="sc">==</span> <span class="fl">1.0</span>) {</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>      Rcpp<span class="sc">::</span><span class="fu">warning</span>(</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>        <span class="st">"Steepness is subject to a logit transformation. "</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>        <span class="st">"Fixing it at 1.0 is not currently possible."</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>      );</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>    }</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    <span class="fu">BevHolt.log_rzero.resize</span>(<span class="dv">1</span>);</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    BevHolt.log_rzero[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>log_rzero[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    return <span class="fu">BevHolt.evaluate_mean</span>(spawners, phi_0);</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  }</span></code></pre></div>
<p>## Step 3: Create a copy of this function.</p>
<p>Rename it to <code>evaluate_mean_RTMB</code> and modify the type from
<code>virtual double</code> to <code>ADrep</code>. Add documentation and
wrap the entire function in:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#ifdef TMB_MODEL </span></span>
<span><span class="va">...</span></span>
<span><span class="co">#endif</span></span></code></pre></div>
<p>This will ensure that this function is only compiled when TMB is
being used.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">#ifdef TMB_MODEL</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="sc">/</span><span class="er">**</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>   <span class="er">*</span> <span class="er">@</span>brief Evaluate recruitment using the Beverton<span class="sc">--</span>Holt stock<span class="sc">--</span>recruitment</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>   <span class="sc">*</span> relationship.</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>   <span class="sc">*</span> <span class="er">@</span>param spawners Spawning biomass per time step.</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>   <span class="sc">*</span> <span class="er">@</span>param phi_0 The biomass at unfished levels.</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>   <span class="sc">*</span><span class="er">/</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>   ADrep <span class="fu">evaluate_mean_RTMB</span>(double spawners, double phi_0) {</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    fims_popdy<span class="sc">::</span>SRBevertonHolt<span class="sc">&lt;</span>double<span class="sc">&gt;</span> BevHolt;</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    <span class="fu">BevHolt.logit_steep.resize</span>(<span class="dv">1</span>);</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    BevHolt.logit_steep[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    <span class="cf">if</span> (this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m <span class="sc">==</span> <span class="fl">1.0</span>) {</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>      Rcpp<span class="sc">::</span><span class="fu">warning</span>(</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>        <span class="st">"Steepness is subject to a logit transformation. "</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>        <span class="st">"Fixing it at 1.0 is not currently possible."</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>      );</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    }</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    <span class="fu">BevHolt.log_rzero.resize</span>(<span class="dv">1</span>);</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>    BevHolt.log_rzero[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>log_rzero[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>    return <span class="fu">BevHolt.evaluate_mean</span>(spawners, phi_0);</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>  }</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  <span class="co">#endif</span></span></code></pre></div>
<p>## Step 4: Modify types:</p>
<ul>
<li>Modify the types of the input parameters from <code>double</code> to
<code>ADrep</code>
</li>
<li>Modify the type within the class declaration function from
<code>double</code> to <code>ad</code>, e.g.
<code>fims_popdy::SRBevertonHolt&lt;double&gt;</code> to
<code>fims_popdy::SRBevertonHolt&lt;ad&gt;</code>
</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a> ADrep <span class="fu">evaluate_mean_RTMB</span>(ADrep spawners, ADrep phi_0) {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  fims_popdy<span class="sc">::</span>SRBevertonHolt<span class="sc">&lt;</span>ad<span class="sc">&gt;</span> BevHolt;</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="fu">BevHolt.logit_steep.resize</span>(<span class="dv">1</span>);</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  BevHolt.logit_steep[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="cf">if</span> (this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m <span class="sc">==</span> <span class="fl">1.0</span>) {</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    Rcpp<span class="sc">::</span><span class="fu">warning</span>(</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>      <span class="st">"Steepness is subject to a logit transformation. "</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>      <span class="st">"Fixing it at 1.0 is not currently possible."</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    );</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  }</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>  <span class="fu">BevHolt.log_rzero.resize</span>(<span class="dv">1</span>);</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  BevHolt.log_rzero[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>log_rzero[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  return <span class="fu">BevHolt.evaluate_mean</span>(spawners, phi_0);</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-5-add-new-pointers-for-each-parameter">Step 5: Add new pointers for each parameter<a class="anchor" aria-label="anchor" href="#step-5-add-new-pointers-for-each-parameter"></a>
</h2>
<p>For each input parameter, set up a new pointer using
<code>const ad*</code> and wrap the input parameter in
<code>adptr()</code>. If there are additional parameters in the model
that are not specified in the input, e.g. <code>logit_steep</code>, add
them as parameters to the input and set up new pointers for them:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>   ADrep <span class="fu">evaluate_mean_RTMB</span>(ADrep spawners, ADrep phi_0, ADrep logit_steep, ADrep log_rzero) {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    fims_popdy<span class="sc">::</span>SRBevertonHolt<span class="sc">&lt;</span>ad<span class="sc">&gt;</span> BevHolt;</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    const ad<span class="sc">*</span> spawners_ptr <span class="ot">=</span> <span class="fu">adptr</span>(spawners);</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    const ad<span class="sc">*</span> phi_0_ptr <span class="ot">=</span> <span class="fu">adptr</span>(phi_0);</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    const ad<span class="sc">*</span> logit_steep_ptr <span class="ot">=</span> <span class="fu">adptr</span>(logit_steep);</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    const ad<span class="sc">*</span> log_rzero_ptr <span class="ot">=</span> <span class="fu">adptr</span>(log_rzero);</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    </span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    <span class="fu">BevHolt.logit_steep.resize</span>(<span class="dv">1</span>);</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    BevHolt.logit_steep[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    <span class="cf">if</span> (this<span class="ot">-&gt;</span>logit_steep[<span class="dv">0</span>].initial_value_m <span class="sc">==</span> <span class="fl">1.0</span>) {</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>      Rcpp<span class="sc">::</span><span class="fu">warning</span>(</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>        <span class="st">"Steepness is subject to a logit transformation. "</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>        <span class="st">"Fixing it at 1.0 is not currently possible."</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>      );</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    }</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="fu">BevHolt.log_rzero.resize</span>(<span class="dv">1</span>);</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    BevHolt.log_rzero[<span class="dv">0</span>] <span class="ot">=</span> this<span class="ot">-&gt;</span>log_rzero[<span class="dv">0</span>].initial_value_m;</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    return <span class="fu">BevHolt.evaluate_mean</span>(spawners, phi_0);</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  }</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-6-set-parameters-to-pointers">Step 6: Set parameters to pointers<a class="anchor" aria-label="anchor" href="#step-6-set-parameters-to-pointers"></a>
</h2>
<ul>
<li>For parameters that are set within the function, set them to
equalthe value of each pointer,
e.g. <code>= *logit_steep_ptr</code>
</li>
<li>For parameters that are passed as input to the
<code>evaluate_mean</code>, pass in the pointers instead</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>   ADrep <span class="fu">evaluate_mean_RTMB</span>(ADrep spawners, ADrep phi_0, ADrep logit_steep, ADrep log_rzero) {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>    fims_popdy<span class="sc">::</span>SRBevertonHolt<span class="sc">&lt;</span>ad<span class="sc">&gt;</span> BevHolt;</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>    const ad<span class="sc">*</span> spawners_ptr <span class="ot">=</span> <span class="fu">adptr</span>(spawners);</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>    const ad<span class="sc">*</span> phi_0_ptr <span class="ot">=</span> <span class="fu">adptr</span>(phi_0);</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>    const ad<span class="sc">*</span> logit_steep_ptr <span class="ot">=</span> <span class="fu">adptr</span>(logit_steep);</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    const ad<span class="sc">*</span> log_rzero_ptr <span class="ot">=</span> <span class="fu">adptr</span>(log_rzero);</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>    <span class="fu">BevHolt.logit_steep.resize</span>(<span class="dv">1</span>);</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    BevHolt.logit_steep[<span class="dv">0</span>] <span class="ot">=</span> <span class="er">*</span>logit_steep_ptr;</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    <span class="cf">if</span> (BevHolt.logit_steep[<span class="dv">0</span>] <span class="sc">==</span> <span class="fl">1.0</span>) {</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>      Rcpp<span class="sc">::</span><span class="fu">warning</span>(</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>        <span class="st">"Steepness is subject to a logit transformation. "</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>        <span class="st">"Fixing it at 1.0 is not currently possible."</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>      );</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>    }</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    <span class="fu">BevHolt.log_rzero.resize</span>(<span class="dv">1</span>);</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>    BevHolt.log_rzero[<span class="dv">0</span>] <span class="ot">=</span> <span class="er">*</span>log_rzero_ptr;</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>    return <span class="fu">BevHolt.evaluate_mean</span>(spawners_ptr, phi_0_ptr);</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>  }</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-7-modify-the-return-statement">Step 7: Modify the return statement<a class="anchor" aria-label="anchor" href="#step-7-modify-the-return-statement"></a>
</h2>
<p>The following code needs to be added to make the return callable from
RTMB:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>int n <span class="ot">=</span> <span class="fu">x.size</span>();</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>ADrep <span class="fu">ans</span>(n); </span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>ad<span class="sc">*</span> Y <span class="ot">=</span> <span class="fu">adptr</span>(ans); </span></code></pre></div>
<p>where x is the input variable.</p>
<p>The return function then needs to be set as a loop over all input and
the return modified to <code>ans</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="cf">for</span>(int <span class="at">i=</span><span class="dv">0</span>; i<span class="sc">&lt;</span>n; i<span class="sc">++</span>){</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  Y[i] <span class="ot">=</span> <span class="fu">module.evaluate</span>(x[i]);</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>}</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>return ans; </span></code></pre></div>
<p>The completed function for BevertonHolt is:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>  <span class="co">#ifdef TMB_MODEL</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>    <span class="sc">/</span><span class="er">**</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>   <span class="er">*</span> <span class="er">@</span>brief Evaluate recruitment using the Beverton<span class="sc">--</span>Holt stock<span class="sc">--</span>recruitment</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>   <span class="sc">*</span> relationship.</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>   <span class="sc">*</span> <span class="er">@</span>param spawners Spawning biomass per time step.</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>   <span class="sc">*</span> <span class="er">@</span>param phi_0 The biomass at unfished levels.</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>   <span class="sc">*</span><span class="er">/</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>   ADrep <span class="fu">evaluate_mean_RTMB</span>(ADrep spawners, ADrep phi_0, ADrep logit_steep, ADrep log_rzero) {</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    fims_popdy<span class="sc">::</span>SRBevertonHolt<span class="sc">&lt;</span>ad<span class="sc">&gt;</span> BevHolt;</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>    const ad<span class="sc">*</span> spawners_ptr <span class="ot">=</span> <span class="fu">adptr</span>(spawners);</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    const ad<span class="sc">*</span> phi_0_ptr <span class="ot">=</span> <span class="fu">adptr</span>(phi_0);</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>    const ad<span class="sc">*</span> logit_steep_ptr <span class="ot">=</span> <span class="fu">adptr</span>(logit_steep);</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>    const ad<span class="sc">*</span> log_rzero_ptr <span class="ot">=</span> <span class="fu">adptr</span>(log_rzero);</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="fu">BevHolt.logit_steep.resize</span>(<span class="dv">1</span>);</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    BevHolt.logit_steep[<span class="dv">0</span>] <span class="ot">=</span> <span class="er">*</span>logit_steep_ptr;</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>    <span class="cf">if</span> (BevHolt.logit_steep[<span class="dv">0</span>] <span class="sc">==</span> <span class="fl">1.0</span>) {</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>      Rcpp<span class="sc">::</span><span class="fu">warning</span>(</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>        <span class="st">"Steepness is subject to a logit transformation. "</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>        <span class="st">"Fixing it at 1.0 is not currently possible."</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>      );</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>    }</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>    <span class="fu">BevHolt.log_rzero.resize</span>(<span class="dv">1</span>);</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    BevHolt.log_rzero[<span class="dv">0</span>] <span class="ot">=</span> <span class="er">*</span>log_rzero_ptr;</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>    int n <span class="ot">=</span> <span class="fu">spawners.size</span>();</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>    ADrep <span class="fu">ans</span>(n); </span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>    ad<span class="sc">*</span> Y <span class="ot">=</span> <span class="fu">adptr</span>(ans); </span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>    <span class="cf">for</span>(int <span class="at">i=</span><span class="dv">0</span>; i<span class="sc">&lt;</span>n; i<span class="sc">++</span>){</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>        Y[i] <span class="ot">=</span> <span class="fu">BevHolt.evaluate_mean</span>(spawners_ptr[i], phi_0_ptr[<span class="dv">0</span>]);</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>    }</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>  </span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>    return ans; </span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>  }</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>  <span class="co">#endif</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-8-expose-to-r">Step 8: Expose to R<a class="anchor" aria-label="anchor" href="#step-8-expose-to-r"></a>
</h2>
<p>The final step is to expose this new function to R. Navigate to the
<code>fims_module.hpp</code> file under <code>src</code> Scroll down to
the BevertonHolt interface:
<code>Rcpp::class_&lt;BevertonHoltRecruitmentInterface&gt;("BevertonHoltRecruitment")</code>.
Add the the following to the list of methods:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>  <span class="fu">.method</span>(<span class="st">"evaluate_mean_RTMB"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>evaluate_mean_RTMB)</span></code></pre></div>
<p>The final interface code chunk should look like:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a> Rcpp<span class="sc">::</span>class_<span class="sc">&lt;</span>BevertonHoltRecruitmentInterface<span class="sc">&gt;</span>(<span class="st">"BevertonHoltRecruitment"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>      <span class="fu">.constructor</span>()</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>      <span class="fu">.field</span>(<span class="st">"logit_steep"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>logit_steep)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>      <span class="fu">.field</span>(<span class="st">"log_rzero"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>log_rzero)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>      <span class="fu">.field</span>(<span class="st">"log_devs"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>log_devs)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>      <span class="fu">.field</span>(<span class="st">"log_r"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>log_r,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>             <span class="st">"recruitment as a random effect on the natural log scale"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>      <span class="fu">.field</span>(<span class="st">"nyears"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>nyears,</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>             <span class="st">"Number of years"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>      <span class="fu">.field</span>(<span class="st">"log_expected_recruitment"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>             <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>log_expected_recruitment,</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>             <span class="st">"Log expectation of the recruitment process"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>      <span class="fu">.method</span>(<span class="st">"get_id"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>get_id)</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>      <span class="fu">.method</span>(<span class="st">"SetRecruitmentProcessID"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>              <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>SetRecruitmentProcessID,</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>              <span class="st">"Set unique ID for recruitment process"</span>)</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>      <span class="fu">.method</span>(<span class="st">"evaluate_mean_RTMB"</span>, <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>evaluate_mean_RTMB,</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>                <span class="st">"Evaluate the mean recruitment using the RTMB framework"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>      <span class="fu">.method</span>(<span class="st">"evaluate_mean"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>              <span class="sc">&amp;</span>BevertonHoltRecruitmentInterface<span class="sc">::</span>evaluate_mean);</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-9-use-function-in-rtmb-modeling">Step 9: Use function in RTMB Modeling<a class="anchor" aria-label="anchor" href="#step-9-use-function-in-rtmb-modeling"></a>
</h2>
<p>Setup the RTMB environment:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/noaa-fims/fimsrtmb" class="external-link">FIMSRTMB</a></span><span class="op">)</span></span>
<span><span class="fu">FIMSRTMB</span><span class="fu">:::</span><span class="fu">setup_RTMB</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Global pointer successfully set: 0x7f506710aee0</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># clear memory</span></span>
<span><span class="fu">clear</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="set-up-a-recruitment-module-using-fims">Set up a recruitment module using FIMS<a class="anchor" aria-label="anchor" href="#set-up-a-recruitment-module-using-fims"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recruitment</span> <span class="op">&lt;-</span> <span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/new.html" class="external-link">new</a></span><span class="op">(</span><span class="va">BevertonHoltRecruitment</span><span class="op">)</span></span>
<span><span class="va">recruitment</span><span class="op">$</span><span class="fu">show</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Reference class object of class "Rcpp_BevertonHoltRecruitment"</span></span>
<span><span class="co">## Field "log_devs":</span></span>
<span><span class="co">## 0x5619a9b4a9f0</span></span>
<span><span class="co">## {"id": 3,</span></span>
<span><span class="co">## "value": 0,</span></span>
<span><span class="co">## "estimated_value": 0,</span></span>
<span><span class="co">## "min": "-Infinity",</span></span>
<span><span class="co">## "max": "Infinity",</span></span>
<span><span class="co">## "estimation type is": "constant"</span></span>
<span><span class="co">## }  Field "log_expected_recruitment":</span></span>
<span><span class="co">## 0x5619ae1c4500</span></span>
<span><span class="co">## {"id": 5,</span></span>
<span><span class="co">## "value": 0,</span></span>
<span><span class="co">## "estimated_value": 0,</span></span>
<span><span class="co">## "min": "-Infinity",</span></span>
<span><span class="co">## "max": "Infinity",</span></span>
<span><span class="co">## "estimation type is": "constant"</span></span>
<span><span class="co">## }  Field "log_r":</span></span>
<span><span class="co">## 0x5619b56191c0</span></span>
<span><span class="co">## {"id": 4,</span></span>
<span><span class="co">## "value": 0,</span></span>
<span><span class="co">## "estimated_value": 0,</span></span>
<span><span class="co">## "min": "-Infinity",</span></span>
<span><span class="co">## "max": "Infinity",</span></span>
<span><span class="co">## "estimation type is": "constant"</span></span>
<span><span class="co">## }  Field "log_rzero":</span></span>
<span><span class="co">## 0x5619b0331070</span></span>
<span><span class="co">## {"id": 2,</span></span>
<span><span class="co">## "value": 0,</span></span>
<span><span class="co">## "estimated_value": 0,</span></span>
<span><span class="co">## "min": "-Infinity",</span></span>
<span><span class="co">## "max": "Infinity",</span></span>
<span><span class="co">## "estimation type is": "constant"</span></span>
<span><span class="co">## }  Field "logit_steep":</span></span>
<span><span class="co">## 0x5619b20b1110</span></span>
<span><span class="co">## {"id": 1,</span></span>
<span><span class="co">## "value": 0,</span></span>
<span><span class="co">## "estimated_value": 0,</span></span>
<span><span class="co">## "min": "-Infinity",</span></span>
<span><span class="co">## "max": "Infinity",</span></span>
<span><span class="co">## "estimation type is": "constant"</span></span>
<span><span class="co">## }  Field "nyears":</span></span>
<span><span class="co">## C++ object &lt;0x5619b3afcf70&gt; of class 'SharedInt' &lt;0x5619ae286730&gt;</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="simulate-data-using-the-fims-module">Simulate data using the FIMS module<a class="anchor" aria-label="anchor" href="#simulate-data-using-the-fims-module"></a>
</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set the two parameters from the recruitment module:</span></span>
<span><span class="va">r0</span> <span class="op">&lt;-</span> <span class="fl">1e+06</span>; <span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">0.75</span>; <span class="va">phi_0</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">recruitment</span><span class="op">$</span><span class="va">log_rzero</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">r0</span><span class="op">)</span></span>
<span><span class="va">recruitment</span><span class="op">$</span><span class="va">logit_steep</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="fu">FIMSRTMB</span><span class="fu">::</span><span class="fu">logit</span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">1.0</span>, <span class="fl">0.75</span><span class="op">)</span>;</span>
<span></span>
<span><span class="co">#spawners from FIMS comparison test data</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9317.537</span>, <span class="fl">9388.807</span>, <span class="fl">9356.490</span>, <span class="fl">9325.130</span>, <span class="fl">8950.209</span>, <span class="fl">8720.467</span>, <span class="fl">8659.642</span>, <span class="fl">8613.245</span>, <span class="fl">7689.096</span>,</span>
<span>        <span class="fl">7434.469</span>, <span class="fl">6989.143</span>, <span class="fl">6556.460</span>, <span class="fl">6105.419</span>, <span class="fl">5831.374</span>, <span class="fl">5350.386</span>, <span class="fl">4978.918</span>, <span class="fl">4758.962</span>, <span class="fl">4159.215</span>,</span>
<span>        <span class="fl">3842.397</span>, <span class="fl">3410.286</span>, <span class="fl">3047.454</span>, <span class="fl">2564.075</span>, <span class="fl">2615.329</span>, <span class="fl">2348.742</span>, <span class="fl">2130.985</span>, <span class="fl">1932.811</span>, <span class="fl">1900.979</span>,</span>
<span>        <span class="fl">1789.534</span>, <span class="fl">1598.782</span>, <span class="fl">1719.572</span>, <span class="fl">1648.269</span><span class="op">)</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">X</span> <span class="op">*</span> <span class="fl">0</span></span>
<span><span class="va">sdy</span> <span class="op">&lt;-</span> <span class="fl">7500</span> <span class="co">#observation error around bevertonholt</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># evaluate returns the bevertonholt function given the parameters and x</span></span>
<span>    <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">recruitment</span><span class="op">$</span><span class="fu">evaluate_mean</span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">phi_0</span><span class="op">)</span></span>
<span>    <span class="co"># simulate random noise around the mean</span></span>
<span>    <span class="va">Y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">sdy</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="RTMB_add_module_files/figure-html/simulate-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="set-up-rtmb-model">Set up RTMB model<a class="anchor" aria-label="anchor" href="#set-up-rtmb-model"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Y</span>, x <span class="op">=</span> <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>log_rzero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span>, logit_steep <span class="op">=</span> <span class="fl">0</span>,</span>
<span>            ln_sdy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu">getAll</span><span class="op">(</span><span class="va">par</span>, <span class="va">dat</span><span class="op">)</span></span>
<span>    <span class="va">sdy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">ln_sdy</span><span class="op">)</span></span>
<span>    <span class="va">mean_recruitment</span> <span class="op">&lt;-</span> <span class="va">recruitment</span><span class="op">$</span><span class="fu">evaluate_mean_RTMB</span><span class="op">(</span></span>
<span>        spawners <span class="op">=</span> <span class="fu">advector</span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, phi_0 <span class="op">=</span> <span class="fu">advector</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>        logit_steep <span class="op">=</span> <span class="fu">advector</span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">logit_steep</span><span class="op">)</span>,</span>
<span>        log_rzero <span class="op">=</span> <span class="fu">advector</span><span class="op">(</span><span class="va">par</span><span class="op">$</span><span class="va">log_rzero</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">nll</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">nll</span> <span class="op">&lt;-</span> <span class="va">nll</span> <span class="op">-</span> <span class="fu">RTMB</span><span class="fu">::</span><span class="fu">dnorm</span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">mean_recruitment</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">sdy</span>, <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">nll</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-tmb-object-and-optimize">Generate TMB object and optimize<a class="anchor" aria-label="anchor" href="#generate-tmb-object-and-optimize"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">RTMB</span><span class="fu">::</span><span class="fu">MakeADFun</span><span class="op">(</span><span class="va">mod</span>, <span class="va">par</span><span class="op">)</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">par</span>, <span class="va">obj</span><span class="op">$</span><span class="va">fn</span>, <span class="va">obj</span><span class="op">$</span><span class="va">gr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## outer mgc:  1018152 </span></span>
<span><span class="co">## outer mgc:  82367.92 </span></span>
<span><span class="co">## outer mgc:  54060.36 </span></span>
<span><span class="co">## outer mgc:  20589.24 </span></span>
<span><span class="co">## outer mgc:  16981.42 </span></span>
<span><span class="co">## outer mgc:  3841.6 </span></span>
<span><span class="co">## outer mgc:  2542.75 </span></span>
<span><span class="co">## outer mgc:  1042.539 </span></span>
<span><span class="co">## outer mgc:  2049.42 </span></span>
<span><span class="co">## outer mgc:  1160.555 </span></span>
<span><span class="co">## outer mgc:  854.7764 </span></span>
<span><span class="co">## outer mgc:  913.3611 </span></span>
<span><span class="co">## outer mgc:  825.0972 </span></span>
<span><span class="co">## outer mgc:  300.6294 </span></span>
<span><span class="co">## outer mgc:  157.265 </span></span>
<span><span class="co">## outer mgc:  43.9615 </span></span>
<span><span class="co">## outer mgc:  20.57949 </span></span>
<span><span class="co">## outer mgc:  8.150058 </span></span>
<span><span class="co">## outer mgc:  4.185564 </span></span>
<span><span class="co">## outer mgc:  2.558583 </span></span>
<span><span class="co">## outer mgc:  0.9774273 </span></span>
<span><span class="co">## outer mgc:  0.5983629 </span></span>
<span><span class="co">## outer mgc:  0.2017957 </span></span>
<span><span class="co">## outer mgc:  0.1237911 </span></span>
<span><span class="co">## outer mgc:  0.009367911 </span></span>
<span><span class="co">## outer mgc:  0.001011514</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span><span class="op">$</span><span class="va">par</span></span></code></pre></div>
<pre><code><span><span class="co">##   log_rzero logit_steep      ln_sdy </span></span>
<span><span class="co">##  13.8394270   0.7699375   8.8467662</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r0</span>; <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="st">"log_rzero"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1e+06</span></span></code></pre>
<pre><code><span><span class="co">## log_rzero </span></span>
<span><span class="co">##   1024205</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span>; <span class="fu">FIMSRTMB</span><span class="fu">::</span><span class="fu">inv_logit</span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">1.0</span>, <span class="va">opt</span><span class="op">$</span><span class="va">par</span><span class="op">[</span><span class="st">"logit_steep"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.75</span></span></code></pre>
<pre><code><span><span class="co">## [1] 0.7468059</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kelli F. Johnson, Jon K. T. Brodziak, Kathryn L. Doering, Andrea M. Havron, Ronald Klasky, Peter T. Kuriyama, Christopher M. Legault, Bai Li, Timothy J. Miller, Cole C. Monnahan, Megumi C. Oshima, Kyle W. Shertzer, Christine C. Stawitz, Jane Y. Sullivan, Matthew Supernaw, Ian G. Taylor, Nathan R. Vaughan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
